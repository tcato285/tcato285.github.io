
defineM("translator",function(g,d,f){function m(a,b,c){for(var h,e=0,r=b.length;e<r;e++)if(h=!1,b[e].type===c){for(var d=0,f=a.length;d<f;d++)if(b[e].name===a[d].name){h=!0;break}h||a.push(b[e])}return a}var q=!1,t=['<div class="row">\n   <div class="col-md-9">\n       <div class="row">\n           <div class="col-md-12">\n               <div class="tr-layout">',"                   <label>"+f("Select language:")+"</label>",'                   <div class="tr-select clearfix">\n                       <select class="form-control" name="translateSelect">\n                       </select>\n                       <div class="tr-select__button-wrapper">',
'                           <button class="btn btn-primary tr-select__button tr-select__button_add">'+f("Add language")+"</button>",'                           <button class="btn btn-default tr-select__button tr-select__button_import" data-tooltipster="top" title="'+f("Import")+'"><span class="mbr-icon-file-export"></span></button>','                           <button class="btn btn-default tr-select__button tr-select__button_export" data-tooltipster="top" title="'+f("Export")+'"><span class="mbr-icon-file-import"></span></button>',
'                           <button class="btn btn-danger tr-select__button tr-select__button_delete" data-tooltipster="top" title="'+f("Delete")+'"><span class="mbr-icon-trash"></span></button>','                       </div>\n                   </div>\n               </div>\n           </div>\n       </div>\n       <div class="tr-editor-wrapper"></div>\n   </div>\n   <div class="col-md-3">','       <h3 class="tr-title">'+f("Select program unit:")+"</h3>",'       <ul class="tr-units" id="accordion">\n           <li>',
'               <a class="tr-units__title tr-units__title_active tr-units__title_interface" href="#">'+f("Interface")+"</a>","           </li>\n       </ul>\n   </div>\n</div>"].join("\n"),u=g(['<div class="row">\n    <div class="col-md-12">\n        <div class="table-wrapper-head-fake">\n                <div class="table-wrapper-head">\n                   <table class="table table-bordered">\n                       <thead>\n                           <tr>',"                               <th>"+f("Phrases")+
' <span class="phrases-total">(<span class="quantity"></span> '+f("total")+")</span></th>","                               <th>"+f("Translations")+' <a href="#" class="untranslated">(<span class="quantity"></span> '+f("untranslated")+")</a></th>",'                           </tr>\n                       </thead>\n                   </table>\n                </div>\n        </div>\n        <div class="table-wrapper tr-layout">\n           <table class="table tr-table table-bordered">\n               <tbody>\n               </tbody>\n           </table>\n        </div>\n    </div>\n    <div class="col-md-6">\n        <div class="form-group">\n            <textarea class="form-control phrase-txt" readonly rows="5"></textarea>\n        </div>\n    </div>\n    <div class="col-md-6">\n        <div class="form-group">\n            <textarea class="form-control translate-txt" rows="5"></textarea>\n        </div>\n    </div>\n    <div class="col-md-12">\n       <div class="tr-controls">',
'           <button class="btn btn-primary">'+f("Save")+"</button>","       </div>\n    </div>\n</div>"].join("\n")),k={name:"MobiriseTranslator",init:function(){d.showPreloader();var a=this,b;a.$modal=b=d.showDialog({title:f("Mobirise Translator"),className:"tr-modal",body:t,hide:function(){q&&d.reloadTranslator(a)}});a.$translateSelect=b.find('[name="translateSelect"]');a.$trUnits=b.find(".tr-units");a.$interfaceUnit=b.find(".tr-units__title_interface");a.$editorWrapper=b.find(".tr-editor-wrapper");
a.$addButton=b.find(".tr-select__button_add");a.$importButton=b.find(".tr-select__button_import");a.$exportButton=b.find(".tr-select__button_export");a.$deleteButton=b.find(".tr-select__button_delete");a.$translateSelect.on("change",function(c){c=g(this);var b=c.attr("data-unit"),e=c.val();d.allowLanguage(e,b).then(function(c){c?(a.$deleteButton.removeClass("disabled"),a.$exportButton.removeClass("disabled")):(a.$deleteButton.addClass("disabled"),a.$exportButton.addClass("disabled"));v.init(b,e)})});
a.$interfaceUnit.on("click",function(c){a.fillingTranslateSelect("interface");a.$trUnits.find(".collapse.in").siblings(".tr-units__title").trigger("click");a.$trUnits.find(".tr-units__list-item").removeClass("tr-units__list-item_active")});a.$addButton.on("click",function(c){w.init(a.$translateSelect.attr("data-unit"))});a.$importButton.on("click",function(c){d.runFileDialog({filter:"JSON (*.json)"}).then(function(c){d.importLanguage(c,a)})});a.$exportButton.on("click",function(c){var b=a.$translateSelect.attr("data-unit"),
e=a.$translateSelect.val();d.runFileDialog({path:b+"_"+e+".json",filter:"JSON (*.json)",save:!0}).then(function(c){return d.exportLanguage(b,e,c)}).then(function(){d.alertDlg("Export is complete.")})});a.$deleteButton.on("click",function(c){var b=a.$translateSelect.attr("data-unit"),e=a.$translateSelect.val();d.confirmDlg("Do you want to remove this language?",function(c){c&&d.deleteLanguage(e,b).then(function(){a.fillingTranslateSelect(b).then(function(){d.alertDlg(f("Language file successfully deleted!"))})}).fail(function(){d.alertDlg(f("Error removal language file!"))})})});
d.getExportedAddons().then(function(c){g.when(function(){var b=g.Deferred();d.getValidLanguageThemes().then(function(e){a.appendUnit(f("Themes"),"themes",m(e,c,"theme"));b.resolve()});return b}(),function(){var b=g.Deferred();d.getValidLanguagePlugin().then(function(e){a.appendUnit(f("Extensions"),"extensions",m(e,c,"plugin"));b.resolve()});return b}()).then(function(){a.fillingTranslateSelect("interface")}).then(function(){d.hidePreloader();a.$trUnits.find(".tr-units__title").on("click",function(){a.$trUnits.find(".tr-units__title").removeClass("tr-units__title_active");
g(this).addClass("tr-units__title_active")});a.$trUnits.find(".tr-units__list-item").on("click",function(){a.$trUnits.find(".tr-units__list-item").removeClass("tr-units__list-item_active");g(this).addClass("tr-units__list-item_active")})})});d.initTooltips()},fillingTranslateSelect:function(a,b){var c=g.Deferred(),h=this;d.getTranslateFilesInfo(a).then(function(e){var d="";h.existingLanguages=function(){for(var b={},c=0,a=e.length;c<a;c++)b[e[c].language]=e[c].title;return b}();e=e.filter(function(c,
b,a){return"en"!==c.language});if(e.length)for(var f=0,g=e.length;f<g;f++)d+='<option value="'+e[f].language+'" >'+e[f].title+"</option>";else d='<option value="empty"></option>';h.$translateSelect.html(d);h.$translateSelect.attr("data-unit",a);h.$translateSelect.trigger("change");b&&"en"!==b&&(h.$translateSelect.val(b),h.$translateSelect.trigger("change"));c.resolve()});return c.promise()},appendUnit:function(a,b,c){var h=this;a=g(['<li class="panel">','    <a class="tr-units__title" href="#'+b+
'" data-toggle="collapse" data-parent="#accordion">'+a+"</a>",'    <div class="panel-collapse collapse tr-units__list" id="'+b+'">',"    </div>\n</li>"].join("\n"));b=a.find(".tr-units__list");for(var e,d=0,f=c.length;d<f;d++)e=g('<a class="tr-units__list-item" data-unit-name="'+c[d].name+'" href="#">'+c[d].title+"</a>"),e.on("click",function(b){return function(){h.fillingTranslateSelect(c[b].name)}}(d)),b.append(e);this.$trUnits.append(a)},appendUnitItem:function(a,b,c){var d=this,e=d.$trUnits.find("#"+
a),f;e.find('[data-unit-name="'+b.name+'"]').length?(f=e.find('[data-unit-name="'+b.name+'"]'),f.off().on("click",function(){d.fillingTranslateSelect(b.name,c);d.$trUnits.find(".tr-units__list-item").removeClass("tr-units__list-item_active");g(this).addClass("tr-units__list-item_active")}),e.hasClass("in")||e.siblings('[href="#'+a+'"]').trigger("click"),f.trigger("click")):(f=g('<a class="tr-units__list-item" data-unit-name="'+b.name+'" href="#">'+b.title+"</a>"),"en"===c&&(f.on("click",function(){d.fillingTranslateSelect(b.name,
c);d.$trUnits.find(".tr-units__list-item").removeClass("tr-units__list-item_active");g(this).addClass("tr-units__list-item_active")}),e.append(f),e.hasClass("in")||e.siblings('[href="#'+a+'"]').trigger("click"),f.trigger("click")))}},v={init:function(a,b){var c=this;"empty"!==b&&a?(c.$editor=u,c.$trTable=c.$editor.find(".tr-table"),c.$phrase=c.$editor.find(".phrase-txt"),c.$translate=c.$editor.find(".translate-txt"),c.$saveButton=c.$editor.find(".tr-controls button"),c.$phrasesTotal=c.$editor.find(".phrases-total"),
c.$untranslated=c.$editor.find(".untranslated"),setTimeout(function(){c.$saveButton.on("click",function(h){q=!0;d.showPreloader();d.getTranslateFileData(b,a).then(function(e){d.getTranslationsFolder(a);var f={},h;for(h in c._bufferGroups){f[h]||(f[h]=[]);for(var g in c._bufferGroups[h])f[h].push({phrase:g,translate:c._bufferGroups[h][g],active:!0})}e.groups=f;return d.setTranslateFileData(b,a,JSON.stringify(e,null,"    "))}).then(function(){d.hidePreloader();d.alertDlg(f("A translation was saved successfully!"));
k.$deleteButton.removeClass("disabled");k.$exportButton.removeClass("disabled")}).fail(function(){d.hidePreloader();d.alertDlg(f("translate file rewrite error"))})})},0),k.$editorWrapper.empty().append(c.$editor),c.fillTable(a,b)):c.appendInfo("<h5>"+f('There are no translations. Click to "ADD LANGUAGE".')+"</h5>")},fillTable:function(a,b){var c=this;d.getTranslateFileData(b,a).then(function(b){var a="",d,k=0,n=0;if(b.groups){c._bufferGroups=c._groupsArrayToObj(b.groups);for(var l in b.groups){d=
l.replace(/web\/app\/interface\/app-/,"");d=d.replace(/-plugin-/,"");d=d.replace(/\.js/,"");for(var a=a+['<tr class="tr-table__group">','   <td colspan="2">'+d+"</td>","</tr>"].join("\n"),p=0,m=b.groups[l].length;p<m;p++)++k,(d=b.groups[l][p].translate.replace(/<[^>]*>/g,""))||++n,a+=['<tr class="tr-table__item '+(d?"":"tr-table__item_empty")+'" data-group="'+l+'">','   <td class="tr-table__phrase">',"       "+b.groups[l][p].phrase.replace(/<[^>]*>/g,""),'   </td>\n   <td class="tr-table__translate">',
"       "+d,"   </td>\n</tr>"].join("\n")}c.$phrasesTotal.find(".quantity").text(k);c._reinitUntranslated(n);c.$trTable.find("tbody").empty().append(a);c.$trTable.find(".tr-table__item").on("click",function(b){var a=g(this),d=a.find(".tr-table__phrase"),e=a.find(".tr-table__translate"),f=a.attr("data-group");c.$trTable.find(".tr-table__item").removeClass("tr-table__item_active");a.addClass("tr-table__item_active");c.$phrase.val(d.text().trim());c.$translate.val(e.text().trim());c.$translate.focus();
c.$translate.off();c.$translate.on("input",function(b){(b=g(this).val().replace(/<[^>]*>/g,"").trim())?a.hasClass("tr-table__item_empty")&&(a.removeClass("tr-table__item_empty"),c._reinitUntranslated(--n)):a.hasClass("tr-table__item_empty")||(a.addClass("tr-table__item_empty"),c._reinitUntranslated(++n));e.text(b);c._bufferGroups[f][d.text().trim()]=b})})}else c.appendInfo(f('Parameter "groups" in translate file is empty!'),1)}).fail(function(b){c.appendInfo("Error getting data.",1)})},_filterBySrcData:function(a,
b){var c={};a=this._groupsArrayToObj(a);for(var d in b)if(b[d].length){c[d]=[];for(var e=0,f=b[d].length;e<f;e++)a[d]&&a[d][b[d][e].phrase]?c[d].push({phrase:b[d][e].phrase,translate:a[d][b[d][e].phrase],active:b[d][e].active}):c[d].push(b[d][e])}return c},_reinitUntranslated:function(a){var b=this;b.$untranslated.find(".quantity").text(a);if(0<a)b.$untranslated.off().on("click",function(){var a=b.$trTable.find(".tr-table__item_empty").first(),d=b.$editor.find(".table-wrapper");d.scrollTop(d.scrollTop()+
a.position().top-a.height()-10);a.trigger("click")});else b.$untranslated.off()},_groupsArrayToObj:function(a){var b={},c;for(c in a){b[c]||(b[c]={});for(var d=0,e=a[c].length;d<e;d++)b[c][a[c][d].phrase]=a[c][d].translate}return b},appendInfo:function(a,b){k.$editorWrapper.empty().append('<div class="tr-info '+(b?"tr-info_error":"")+'">'+a+"</div>")}},w={init:function(a){var b=this;b.$modal=d.showDialog({title:f("Select language: "),className:"tr-modal-list",body:'<div class="row">\n   <div class="col-md-12">\n       <ul class="tr-lang-list">\n       </ul>\n   </div>\n</div>',
buttons:{cancel:{label:f("Cancel"),className:"btn-default"},success:{label:f("Ok"),className:"btn-primary",callback:function(){if(b.selectedLanguage)d.createNewTranslation(b.selectedLanguage,a).then(function(){k.fillingTranslateSelect(a,b.selectedLanguage)}).fail(function(b){d.alertDlg(f("Error create new translation file!"))});else return d.alertDlg(f("Please choose the language.")),!1}}}});b.$list=b.$modal.find(".tr-lang-list");b.fillList();b.$listItems=b.$list.find(".tr-lang-list__item");b.$listItems.on("click",
function(a){a=g(this);a.hasClass("tr-lang-list__item_active")||(b.$listItems.removeClass("tr-lang-list__item_clicked"),a.addClass("tr-lang-list__item_clicked"),b.selectedLanguage=a.attr("data-language"))});b.selectedLanguage=""},fillList:function(){var a="",b;for(b in d.languageList)a+='<li class="tr-lang-list__item '+(k.existingLanguages[b]?"tr-lang-list__item_active":"")+'" data-language="'+b+'">'+d.languageList[b]+"</li>";this.$list.empty().append(a)}};d.regExtension({name:"translator",events:{showAppSettings:function(a){a=
a.find('[name="language"]').closest(".input-group");var b=g(['<div class="input-group" style="float: left">','   <button class="btn btn-primary" style="margin: 0">'+f("EDIT")+"</button>","</div>"].join("\n"));a.after(b).css({"float":"left"});b.find("button").on("click",k.init.bind(k))}}})},["jQuery","mbrApp","TR()"]);
